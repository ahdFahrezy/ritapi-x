{% extends 'base.html' %}
{% load static %}

{% block title %}Blocked IP Map{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm rounded-4">
                <!-- Header -->
                <div class="card-header d-flex align-items-center">
                    <i class="fas fa-map-marked-alt me-2"></i>
                    <h3 class="card-title mb-0">üåç Blocked IP Map</h3>
                </div>

                <div class="card-body">
                    <div id="map" style="height: 60vh; border-radius: 10px;"></div>
                    
                    <!-- Legend -->
                    <div id="map-legend" class="mt-3 p-2 border rounded-3 bg-light">
                        <strong>Severity:</strong>
                        <span class="badge bg-danger">Critical</span>
                        <span class="badge bg-warning text-dark">High</span>
                        <span class="badge bg-info text-dark">Medium</span>
                        <span class="badge bg-success">Low</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const map = L.map("map").setView([20, 0], 2);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 6,
        attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    const severityColors = {
        "critical": "red",
        "high": "orange",
        "medium": "blue",
        "low": "green"
    };

    // Fetch blocked IP data
    fetch("{% url 'blocked_ip_data' %}")
    .then(res => res.json())
    .then(json => {
        json.data.forEach(item => {
            const color = severityColors[item.severity] || "gray";

            L.circleMarker([item.lat, item.lon], {
                radius: 7,
                fillColor: color,
                color: "#000",
                weight: 1,
                opacity: 0.8,
                fillOpacity: 0.8
            })
            .addTo(map)
            .bindPopup(`
                <b>IP:</b> ${item.ip}<br>
                <b>Country:</b> ${item.country}<br>
                <b>Reason:</b> ${item.reason}<br>
                <b>Severity:</b> ${item.severity}<br>
                <b>Blocked At:</b> ${item.time}
            `);
        });
    })
    .catch(err => console.error("Error loading blocked IPs:", err));
});
</script>
{% endblock %}
