{% extends 'base.html' %}
{% load static %}

{% block title %}Alert Management{% endblock %}

{% block content %}
<div class="container-fluid">

    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">
                        <i class="fas fa-bell"></i> Alert Statistics
                    </h3>
                    <div class="card-tools">
                        <form id="filter-form" class="d-flex align-items-center">
                            <label for="filter-period" class="me-2 mb-0 text-white">
                                Filter:
                            </label>
                            <select id="filter-period" class="form-select me-2" style="min-width: 140px;">
                                <option value="all" selected>All</option>
                                <option value="1d">Last 24 Hours</option>
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                            </select>
                        </form>
                    </div>
                </div>


                <div class="card-body">
                    <canvas id="alertChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="card">
                
                <!-- Header + Search -->
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">
                        <i class="fas fa-bell"></i> Alert Table
                    </h3>
                    <div class="card-tools">
                        <form method="get" class="d-flex">
                            <input type="text" name="q" class="form-control me-2" placeholder="Search alert..."
                                  value="{{ query }}">
                            <select name="severity" class="form-select me-2">
                                <option value="">All Severities</option>
                                <option value="low" {% if severity_filter == "low" %}selected{% endif %}>Low</option>
                                <option value="medium" {% if severity_filter == "medium" %}selected{% endif %}>Medium</option>
                                <option value="high" {% if severity_filter == "high" %}selected{% endif %}>High</option>
                                <option value="critical" {% if severity_filter == "critical" %}selected{% endif %}>Critical</option>
                            </select>
                            <button type="submit" class="btn btn-primary">Filter</button>
                        </form>
                    </div>
                </div>

                <div class="card-body">

                    <!-- âš ï¸ Warning if no results -->
                    {% if error_message %}
                    <div class="card mt-3 border-warning">
                        <div class="card-body text-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            {{ error_message }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- ðŸ“œ Alerts Table -->
                    <div class="table-responsive mt-3 rounded-4">
                        <table class="table table-bordered table-striped align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th class="text-center" style="width: 60px;">No</th>
                                    <th>Type</th>
                                    <th>IP Address</th>
                                    <th>Severity</th>
                                    <th>Detail</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for a in alerts %}
                                <tr>
                                    <td class="text-center">{{ forloop.counter0|add:alerts.start_index }}</td>
                                    <td>{{ a.alert_type }}</td>
                                    <td><code>{{ a.ip_address }}</code></td>
                                    <td>
                                        {% if a.severity == "critical" %}
                                            <span class="badge bg-danger">{{ a.severity|title }}</span>
                                        {% elif a.severity == "high" %}
                                            <span class="badge bg-warning text-dark">{{ a.severity|title }}</span>
                                        {% elif a.severity == "medium" %}
                                            <span class="badge bg-info">{{ a.severity|title }}</span>
                                        {% else %}
                                            <span class="badge bg-success">{{ a.severity|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ a.detail|truncatechars:50 }}</td>
                                    <td class="text-muted">{{ a.timestamp|date:"M d, Y H:i" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-3x mb-3"></i>
                                        <h5>No alerts found</h5>
                                        <p>Once alerts are triggered, they will appear here.</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if alerts and alerts.has_other_pages %}
                    <nav aria-label="Alerts pagination" class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if alerts.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">&laquo; First</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ alerts.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">Previous</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">&laquo; First</span></li>
                                <li class="page-item disabled"><span class="page-link">Previous</span></li>
                            {% endif %}

                            {% for num in alerts.paginator.page_range %}
                                {% if alerts.number == num %}
                                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                                {% elif num > alerts.number|add:'-3' and num < alerts.number|add:'3' %}
                                    <li class="page-item"><a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">{{ num }}</a></li>
                                {% endif %}
                            {% endfor %}

                            {% if alerts.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ alerts.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">Next</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ alerts.paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">Last &raquo;</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">Next</span></li>
                                <li class="page-item disabled"><span class="page-link">Last &raquo;</span></li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script nonce="{{ request.csp_nonce }}">
async function loadAlertChart() {
    const period = $('#filter-period').val() || 'all'; // default to 'all'
    const url = new URL("{% url 'alert_chart_data' %}", window.location.origin);
    url.searchParams.append("period", period);

    try {
        const response = await fetch(url);
        const data = await response.json();

        const ctx = document.getElementById('alertChart').getContext('2d');

        // Destroy old chart if it exists
        if (window.alertChartInstance) {
            window.alertChartInstance.destroy();
        }

        const colors = {
            Low: 'rgba(0, 200, 83, 0.7)',
            Medium: 'rgba(255, 193, 7, 0.7)',
            High: 'rgba(255, 87, 34, 0.7)',
            Critical: 'rgba(244, 67, 54, 0.8)'
        };

        const titleMap = {
            'all': 'Alerts by Severity (All Data)',
            '1d': 'Alerts by Severity (Last 24 Hours)',
            '7d': 'Alerts by Severity (Last 7 Days)',
            '30d': 'Alerts by Severity (Last 30 Days)'
        };

        window.alertChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Alerts Count',
                    data: data.data,
                    backgroundColor: data.labels.map(l => colors[l]),
                    borderColor: data.labels.map(l => colors[l].replace('0.7', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: titleMap[period] || 'Blocked Alerts by Severity',
                        color: '#fff'
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#fff' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#fff' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                }
            }
        });

    } catch (error) {
        console.error("Failed to load alert chart:", error);
        const ctx = document.getElementById('alertChart').getContext('2d');
        ctx.font = '16px Arial';
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        ctx.fillText('Failed to load chart data. Please try again later.', ctx.canvas.width / 2, ctx.canvas.height / 2);
    }
}

$(document).ready(function() {
    loadAlertChart();
    $('#filter-period').on('change', loadAlertChart);
    setInterval(loadAlertChart, 60000); // auto refresh every 60 seconds
});
</script>
{% endblock %}