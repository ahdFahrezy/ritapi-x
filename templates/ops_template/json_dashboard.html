{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">

        <!-- Header + Add Button -->
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="card-title">
            <i class="fas fa-database"></i>
            JSON Schema Enforcer
          </h3>
          <div class="card-tools">
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#schemaModal">
              <i class="bi bi-plus-circle"></i> Add Schema
            </button>
          </div>
        </div>

        <div class="card-body">

          <!-- âš ï¸ Warning if no results -->
          {% if error_message %}
          <div class="card mt-3 border-warning">
            <div class="card-body text-warning">
              <i class="bi bi-exclamation-triangle"></i>
              {{ error_message }}
            </div>
          </div>
          {% endif %}

          <!-- ðŸ“œ Schema Table -->
          <div class="table-responsive mt-3 rounded-4">
            <table class="table table-bordered table-striped align-middle">
              <thead class="table-dark">
                <tr>
                  <th class="text-center" style="width: 50px;">No</th>
                  <th style="width: 15%">Name</th>
                  <th style="width: 20%">Service</th>
                  <th style="width: 15%">Endpoint</th>
                  <th style="width: 8%">Method</th>
                  <th style="width: 8%">Status</th>
                  <th style="width: 15%">Rollout Mode</th>
                  <th style="width: 34%" class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for schema in page_obj %}
                <tr>
                  <td class="text-center">
                      {{ forloop.counter0|add:page_obj.start_index }}
                  </td>
                  <td>{{ schema.name }}</td>
                  <td>
                    {% if schema.service %}
                      <code>{{ schema.service.target_base_url }}</code>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td><code>{{ schema.endpoint }}</code></td>
                  <td><span class="badge bg-primary">{{ schema.method }}</span></td>
                  <td>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox"
                             {% if schema.is_active %}checked{% endif %}
                             data-schema-id="{{ schema.id }}">
                    </div>
                  </td>
                  <td>
                    {% if schema.rollout_mode == 'enforce' %}
                      <span class="badge bg-success">Enforce</span>
                    {% else %}
                      <span class="badge bg-secondary">Monitor</span>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    <button class="btn btn-sm btn-warning me-1 edit-schema-btn"
                            data-bs-toggle="modal" data-bs-target="#schemaModal"
                            data-schema-id="{{ schema.id }}"
                            data-schema-name="{{ schema.name|escapejs }}"
                            data-schema-endpoint="{{ schema.endpoint|escapejs }}"
                            data-schema-method="{{ schema.method|escapejs }}"
                            data-schema-json="{{ schema.schema_json|escapejs }}"
                            data-schema-desc="{{ schema.description|default_if_none:''|escapejs }}"
                            data-service-uuid="{{ schema.service.uuid|default_if_none:'' }}"
                            data-rollout-mode="{{ schema.rollout_mode }}">
                      <i class="bi bi-pencil-square"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-danger delete-schema-btn"
                            data-schema-id="{{ schema.id }}">
                      <i class="bi bi-trash"></i> Delete
                    </button>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="8" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <h5>No schema available</h5>
                    <p>Add your first JSON schema to see it listed here.</p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          {% if page_obj and page_obj.has_other_pages %}
          <nav aria-label="Schema pagination" class="mt-4">
            <ul class="pagination justify-content-center">
              {% if page_obj.has_previous %}
                <li class="page-item"><a class="page-link" href="?page=1">&laquo; First</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">&laquo; First</span></li>
                <li class="page-item disabled"><span class="page-link">Previous</span></li>
              {% endif %}

              {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                  <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                  <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                {% endif %}
              {% endfor %}

              {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last &raquo;</a></li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">Next</span></li>
                <li class="page-item disabled"><span class="page-link">Last &raquo;</span></li>
              {% endif %}
            </ul>
          </nav>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal (Add/Edit Schema) -->
<div class="modal fade" id="schemaModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="schemaForm">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="schemaModalLabel">Add Schema</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="schemaId" name="id">
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" id="schemaName" name="name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Service</label>
            <select class="form-control" id="schemaService" name="service_uuid" required>
              <option value="">-- Select Service --</option>
              {% for service in services %}
                <option value="{{ service.uuid }}">{{ service.target_base_url }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Rollout Mode</label>
            <select class="form-control" id="rolloutMode" name="rollout_mode" required>
              <option value="">-- Select Option --</option>
                <option value="monitor">Monitor</option>
                <option value="enforce">Enforce</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Endpoint</label>
            <input type="text" class="form-control" id="schemaEndpoint" name="endpoint" required>
          </div>
          <div class="mb-3">
            <label class="form-label">HTTP Method</label>
            <select class="form-control" id="schemaMethod" name="method" required>
              <option value="GET">GET</option>
              <option value="POST" selected>POST</option>
              <option value="PUT">PUT</option>
              <option value="PATCH">PATCH</option>
              <option value="DELETE">DELETE</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Schema JSON</label>
            <textarea class="form-control font-monospace" id="schemaJson" name="schema_json" rows="8" required
                      spellcheck="false"
                      placeholder='{
  "type": "object",
  "$schema": "http://json-schema.org/draft-04/schema#",
  "required": ["message", "value"],
  "properties": {
    "value": { "type": "string" },
    "message": { "type": "string" }
  }
}'></textarea>
            <div class="invalid-feedback">Please enter valid JSON</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" id="schemaDesc" name="description" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Justification (Optional)</label>
            <textarea class="form-control" id="schemaJustification" name="justification" rows="2" 
                      placeholder="Explain why this change is needed (required for approval if multiple admins exist)"></textarea>
            <div class="form-text">Provide a reason for this change to help with the approval process.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script nonce="{{ request.csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
  // Create button handler
  document.querySelector('[data-bs-target="#schemaModal"]').addEventListener('click', function() {
    document.getElementById("schemaModalLabel").innerText = "Add Schema";
    document.getElementById("schemaForm").reset();
    document.getElementById("schemaId").value = "";
    document.getElementById("schemaJustification").value = "";
    document.getElementById("schemaMethod").value = "POST";
  });

  // Edit buttons handler
  document.querySelectorAll('.edit-schema-btn').forEach(button => {
    button.addEventListener('click', function() {
      const data = this.dataset;
      document.getElementById("schemaModalLabel").innerText = "Edit Schema";
      document.getElementById("schemaId").value = data.schemaId;
      document.getElementById("schemaName").value = data.schemaName;
      document.getElementById("schemaEndpoint").value = data.schemaEndpoint;
      document.getElementById("schemaMethod").value = data.schemaMethod;
      document.getElementById("schemaJson").value = formatJsonString(data.schemaJson);
      document.getElementById("schemaDesc").value = data.schemaDesc;
      document.getElementById("rolloutMode").value = data.rolloutMode || "monitor";
      document.getElementById("schemaService").value = data.serviceUuid;
      document.getElementById("schemaJustification").value = "";
    });
  });

  // Delete buttons handler
  document.querySelectorAll('.delete-schema-btn').forEach(button => {
    button.addEventListener('click', function() {
      const schemaId = this.dataset.schemaId;
      deleteSchema(schemaId);
    });
  });

  // Toggle status handler
  document.querySelectorAll('.form-check-input').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      toggleSchema(this.dataset.schemaId, this.checked);
    });
  });
});

function formatJsonString(jsonStr) {
  try {
    // First decode all escaped characters
    let decodedStr = jsonStr
      .replace(/\\u0027/g, "'")      // Fix single quotes
      .replace(/\\u002D/g, '-')      // Fix hyphens
      .replace(/\\u0022/g, '"')      // Fix double quotes
      .replace(/\\u000D/g, '')       // Remove carriage returns
      .replace(/\\u000A/g, '')       // Remove line feeds
      .replace(/\\\\/g, '\\')        // Fix backslashes
      .replace(/\\n/g, '\n')         // Fix newlines
      .replace(/\\"/g, '"')          // Fix escaped quotes
      .replace(/\\t/g, '\t')         // Fix tabs
      .replace(/'/g, '"');           // Replace single quotes with double quotes

    // Try to parse it first to see if it's already JSON
    try {
      return JSON.stringify(JSON.parse(decodedStr), null, 2);
    } catch {
      // If it's still escaped, try one more time with eval
      // This safely converts the string to a JSON object
      const obj = JSON.parse(decodedStr.replace(/\\\\/g, '\\'));
      return JSON.stringify(obj, null, 2);
    }
  } catch (e) {
    console.error('JSON formatting error:', e);
    return jsonStr;
  }
}

function openEditModal(id, name, endpoint, schemaJson, description, serviceUuid) {
  document.getElementById("schemaModalLabel").innerText = "Edit Schema";
  document.getElementById("schemaId").value = id;
  document.getElementById("schemaName").value = name;
  document.getElementById("schemaEndpoint").value = endpoint;
  document.getElementById("schemaJson").value = formatJsonString(schemaJson);
  document.getElementById("schemaDesc").value = description;
  document.getElementById("schemaService").value = serviceUuid;
  document.getElementById("rolloutMode").value = rollout_mode || "monitor";
}

// Add auto-formatting on input
document.getElementById('schemaJson').addEventListener('input', function() {
  const textarea = this;
  const cursorPos = textarea.selectionStart;
  try {
    const json = JSON.parse(textarea.value);
    const formatted = JSON.stringify(json, null, 2);
    if (formatted !== textarea.value) {
      textarea.value = formatted;
      textarea.selectionStart = cursorPos;
      textarea.selectionEnd = cursorPos;
    }
    textarea.classList.remove('is-invalid');
  } catch (e) {
    // Don't show error while typing
    if (textarea.value.trim()) {
      textarea.classList.add('is-invalid');
    }
  }
});

document.getElementById("schemaForm").onsubmit = function(e) {
  e.preventDefault();
  
  // Validate JSON before submitting
  const jsonInput = document.getElementById("schemaJson");
  try {
    // Try to parse and format the JSON
    const jsonValue = JSON.parse(jsonInput.value);
    jsonInput.value = JSON.stringify(jsonValue, null, 2);
    jsonInput.classList.remove('is-invalid');
  } catch (e) {
    jsonInput.classList.add('is-invalid');
    Swal.fire({
      icon: "error",
      title: "Invalid JSON",
      text: "Please enter valid JSON schema"
    });
    return;
  }
  
  const id = document.getElementById("schemaId").value;
  const url = id ? `/ops/json-enforcer/update/${id}/` : `/ops/json-enforcer/create/`;
  const formData = new FormData(this);

  Swal.fire({
    title: id ? "Update Schema?" : "Create Schema?",
    text: id ? "Do you want to save these changes?" : "Do you want to add this new schema?",
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "Yes, save it",
    cancelButtonText: "Cancel"
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(url, {
        method: "POST",
        body: formData,
        headers: {"X-CSRFToken": formData.get("csrfmiddlewaretoken")},
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          if (data.requires_approval) {
            Swal.fire({
              icon: "info",
              title: "Approval Required",
              text: data.message || "Your request has been submitted for approval",
              footer: data.change_id ? `Change ID: ${data.change_id}` : ''
            }).then(() => {
              location.reload();
            });
          } else {
            Swal.fire({
              icon: "success",
              title: "Success",
              text: data.message || (id ? "Schema has been updated successfully" : "Schema has been created successfully")
            }).then(() => {
              location.reload();
            });
          }
        } else {
          Swal.fire({
            icon: "error",
            title: "Failed",
            text: data.message || "Failed to save schema"
          });
        }
      })
      .catch(() => {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Server error occurred"
        });
      });
    }
  });
};

function deleteSchema(id) {
  Swal.fire({
    title: "Delete Schema",
    html: `
      <p>Are you sure you want to delete this schema?</p>
      <textarea id="deleteJustification" class="form-control mt-3" rows="3" 
                placeholder="Provide justification for deleting this schema (optional)"></textarea>
    `,
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Yes, delete it",
    cancelButtonText: "Cancel",
    preConfirm: () => {
      return document.getElementById('deleteJustification').value;
    }
  }).then((result) => {
    if (result.isConfirmed) {
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      formData.append('justification', result.value || '');
      
      fetch(`/ops/json-enforcer/delete/${id}/`, {
        method: "POST",
        body: formData,
        headers: {"X-CSRFToken": "{{ csrf_token }}"},
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          if (data.requires_approval) {
            Swal.fire({
              icon: "info",
              title: "Approval Required",
              text: data.message || "Delete request has been submitted for approval",
              footer: data.change_id ? `Change ID: ${data.change_id}` : ''
            }).then(() => {
              location.reload();
            });
          } else {
            Swal.fire({
              icon: "success",
              title: "Deleted",
              text: data.message || "Schema has been deleted successfully"
            }).then(() => {
              location.reload();
            });
          }
        } else {
          Swal.fire({
            icon: "error",
            title: "Failed",
            text: data.message || "Failed to delete schema"
          });
        }
      })
      .catch(() => {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Server error occurred"
        });
      });
    }
  });
}

function toggleSchema(id, status) {
  Swal.fire({
    title: "Toggle Schema Status",
    html: `
      <p>Are you sure you want to ${status ? 'activate' : 'deactivate'} this schema?</p>
      <textarea id="toggleJustification" class="form-control mt-3" rows="2" 
                placeholder="Provide justification for this change (optional)"></textarea>
    `,
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "Yes, continue",
    cancelButtonText: "Cancel",
    preConfirm: () => {
      return document.getElementById('toggleJustification').value;
    }
  }).then((result) => {
    if (result.isConfirmed) {
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      formData.append('justification', result.value || '');
      
      fetch(`/ops/json-enforcer/toggle/${id}/`, {
        method: "POST",
        body: formData,
        headers: {"X-CSRFToken": "{{ csrf_token }}"},
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          if (data.requires_approval) {
            Swal.fire({
              icon: "info",
              title: "Approval Required",
              text: data.message || "Toggle request has been submitted for approval",
              footer: data.change_id ? `Change ID: ${data.change_id}` : ''
            }).then(() => {
              location.reload();
            });
          } else {
            Swal.fire({
              icon: "success",
              title: "Success",
              text: data.message || "Schema status has been updated successfully"
            }).then(() => {
              location.reload();
            });
          }
        } else {
          Swal.fire({
            icon: "error",
            title: "Failed",
            text: data.message || "Unable to update status"
          }).then(() => {
            location.reload();
          });
        }
      })
      .catch(() => {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Server error occurred"
        }).then(() => {
          location.reload();
        });
      });
    } else {
      // If cancelled, revert the checkbox
      location.reload();
    }
  });
}
</script>

{% endblock %}